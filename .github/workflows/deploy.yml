name: Deploy to production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag'
        required: false
        default: 'latest'

env:
  TCR_REGISTRY: ${{ secrets.TCR_REGISTRY }}
  TCR_NAMESPACE: ${{ secrets.TCR_NAMESPACE }}

jobs:
  detect-changes:
    name: Detect File Changes
    runs-on: ubuntu-latest
    outputs:
      api_changed: ${{ steps.changed-files.outputs.api_related_any_changed }}
      web_changed: ${{ steps.changed-files.outputs.web_related_any_changed }}
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史以便比较 tags
      
      - name: Detect changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files_yaml: |
            api_related:
              - '**'
              - '!web/**'
            web_related:
              - 'web/**'

  build-api:
    name: Build API Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api_changed == 'true'
    outputs:
      api-image: ${{ steps.meta.outputs.image }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Tencent Cloud TCR
        run: |
          echo "${{ secrets.TCR_PASSWORD }}" | docker login -u ${{ secrets.TCR_USERNAME }} --password-stdin ${{ secrets.TCR_REGISTRY }}

      - name: Extract metadata
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG=${GITHUB_REF#refs/tags/}
          fi
          IMAGE="${{ env.TCR_REGISTRY }}/${{ env.TCR_NAMESPACE }}/${{ secrets.API_REPOSITORY }}:${TAG}"
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Decrypt ENV
        env:
          ENV_PASSPHRASE: ${{ secrets.ENV_PASSPHRASE }}
        run: |
          make decrypt_env env=prod

      - name: Build and push API image
        run: |
          IMAGE="${{ steps.meta.outputs.image }}"
          echo "Building API image: ${IMAGE}"
          docker build -t ${IMAGE} .
          docker push ${IMAGE}
          
          # 同时推送latest标签
                    if [[ "${{ steps.meta.outputs.tag }}" != "latest" ]]; then
                      LATEST_IMAGE="${{ env.TCR_REGISTRY }}/${{ env.TCR_NAMESPACE }}/${{ secrets.API_REPOSITORY }}:latest"
                      docker tag ${IMAGE} ${LATEST_IMAGE}
                      docker push ${LATEST_IMAGE}
                    fi

  build-web:
    name: Build Web Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web_changed == 'true'
    outputs:
      web-image: ${{ steps.meta.outputs.image }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Tencent Cloud TCR
        run: |
          echo "${{ secrets.TCR_PASSWORD }}" | docker login -u ${{ secrets.TCR_USERNAME }} --password-stdin ${{ secrets.TCR_REGISTRY }}

      - name: Extract metadata
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG=${GITHUB_REF#refs/tags/}
          fi
          IMAGE="${{ env.TCR_REGISTRY }}/${{ env.TCR_NAMESPACE }}/${{ secrets.WEB_REPOSITORY }}:${TAG}"
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Build and push Web image
        run: |
          IMAGE="${{ steps.meta.outputs.image }}"
          echo "Building Web image: ${IMAGE}"
          cd web
          docker build -t ${IMAGE} .
          docker push ${IMAGE}
          
          # 同时推送latest标签
          if [[ "${{ steps.meta.outputs.tag }}" != "latest" ]]; then
            LATEST_IMAGE="${{ env.TCR_REGISTRY }}/${{ env.TCR_NAMESPACE }}/${{ secrets.WEB_REPOSITORY }}:latest"
            docker tag ${IMAGE} ${LATEST_IMAGE}
            docker push ${LATEST_IMAGE}
          fi
